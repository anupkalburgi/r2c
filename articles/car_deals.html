<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#1e3a8a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Deal Crusher</title>
    
    <!-- Tailwind CSS (Requires Internet for first load, then caches) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        /* Custom scrollbar hiding for cleaner UI */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        /* Smooth fade for tab switching */
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* Prevent iOS zoom on inputs */
        input {
            font-size: 16px !important; 
        }
    </style>
</head>
<body class="bg-slate-50 font-sans text-slate-900 pb-24 selection:bg-blue-200">

    <!-- Header -->
    <header class="bg-blue-900 text-white p-4 shadow-lg sticky top-0 z-30 pb-4 pt-safe-top">
        <div class="max-w-3xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-2">
                <!-- Icon: Car -->
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-300"><path d="M19 17h2c.6 0 1-.4 1-1v-3c0-.9-.7-1.7-1.5-1.9C18.7 10.6 16 10 16 10s-1.3-1.4-2.2-2.3c-.5-.4-1.1-.7-1.8-.7H5c-.6 0-1.1.4-1.4.9l-1.4 2.9A3.7 3.7 0 0 0 2 12v4c0 .6.4 1 1 1h2"/><circle cx="7" cy="17" r="2"/><circle cx="17" cy="17" r="2"/></svg>
                <h1 class="font-bold text-xl tracking-tight">Deal Crusher</h1>
            </div>
            <div class="flex gap-2">
                <button id="btn-toggle-view" class="text-sm font-semibold px-3 py-1 rounded-full transition-colors bg-blue-800 text-blue-100 hover:bg-blue-700 shadow-sm border border-blue-700">
                    Compare
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-3xl mx-auto p-4">
        
        <!-- VIEW: INPUT FORM -->
        <div id="view-form" class="fade-in">
            <!-- Tabs Container -->
            <div class="flex overflow-x-auto gap-2 mb-4 pb-2 no-scrollbar touch-pan-x" id="tabs-container">
                <!-- Tabs injected by JS -->
            </div>

            <!-- Active Deal Card -->
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden" id="deal-editor">
                
                <!-- Deal Header -->
                <div class="p-4 border-b border-slate-100 bg-slate-50 flex flex-col sm:flex-row sm:items-center justify-between gap-4">
                    <input type="text" id="deal-name" class="bg-transparent font-bold text-xl text-slate-800 border-b border-dashed border-slate-300 focus:border-blue-500 focus:outline-none w-full sm:w-auto" placeholder="Dealer Name">
                    <div class="flex flex-col items-end">
                        <span class="text-xs font-semibold text-slate-500 uppercase tracking-wider">Est. OTD Price</span>
                        <span class="text-2xl font-extrabold text-blue-600" id="header-otd">$0</span>
                    </div>
                </div>

                <div class="p-4 space-y-6">
                    
                    <!-- Section 1: Basics -->
                    <section>
                        <h3 class="text-sm font-bold text-slate-400 uppercase tracking-wider mb-3 flex items-center gap-1">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
                            The Basics
                        </h3>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">MSRP / Sticker</label>
                                <div class="relative">
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-slate-400">$</div>
                                    <input type="number" id="inp-msrp" inputmode="decimal" class="block w-full pl-7 pr-3 py-3 border border-slate-200 bg-white rounded-lg focus:ring-2 focus:ring-blue-200 focus:border-blue-500 outline-none transition-all font-mono text-lg text-slate-800 shadow-sm" placeholder="0">
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">Dealer Discount (-)</label>
                                <div class="relative">
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-red-400">-</div>
                                    <input type="number" id="inp-discount" inputmode="decimal" class="block w-full pl-7 pr-3 py-3 border border-red-100 bg-red-50/30 rounded-lg focus:ring-2 focus:ring-blue-200 focus:border-blue-500 outline-none transition-all font-mono text-lg text-red-600 shadow-sm" placeholder="0">
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">Rebates (-)</label>
                                <div class="relative">
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-red-400">-</div>
                                    <input type="number" id="inp-rebates" inputmode="decimal" class="block w-full pl-7 pr-3 py-3 border border-red-100 bg-red-50/30 rounded-lg focus:ring-2 focus:ring-blue-200 focus:border-blue-500 outline-none transition-all font-mono text-lg text-red-600 shadow-sm" placeholder="0">
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- Section 2: Fees -->
                    <section class="bg-orange-50 p-4 rounded-lg border border-orange-100 shadow-sm">
                        <h3 class="text-sm font-bold text-orange-400 uppercase tracking-wider mb-3 flex items-center gap-1">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
                            Fees & Add-ons
                        </h3>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">Doc Fee</label>
                                <div class="relative">
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-slate-400">$</div>
                                    <input type="number" id="inp-docFee" inputmode="decimal" class="block w-full pl-7 pr-3 py-3 border border-slate-200 bg-white rounded-lg focus:ring-2 focus:ring-blue-200 focus:border-blue-500 outline-none transition-all font-mono text-lg text-slate-800 shadow-sm" placeholder="0">
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">Gov / DMV Fees</label>
                                <div class="relative">
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-slate-400">$</div>
                                    <input type="number" id="inp-govFees" inputmode="decimal" class="block w-full pl-7 pr-3 py-3 border border-slate-200 bg-white rounded-lg focus:ring-2 focus:ring-blue-200 focus:border-blue-500 outline-none transition-all font-mono text-lg text-slate-800 shadow-sm" placeholder="0">
                                </div>
                            </div>
                        </div>
                        
                        <div id="custom-fees-container" class="space-y-3">
                            <!-- Custom fees injected here -->
                        </div>
                        <button id="btn-add-fee" class="mt-3 text-sm text-orange-600 font-medium flex items-center gap-1 hover:text-orange-700 p-2 rounded-md hover:bg-orange-100/50 transition-colors w-full sm:w-auto justify-center sm:justify-start">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                            Add Item (Nitrogen, Etch, etc.)
                        </button>
                    </section>

                    <!-- Section 3: Tax & Trade -->
                    <section>
                        <h3 class="text-sm font-bold text-slate-400 uppercase tracking-wider mb-3 flex items-center gap-1">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="4" y="2" width="16" height="20" rx="2" ry="2"/><line x1="8" y1="6" x2="16" y2="6"/><line x1="16" y1="14" x2="16" y2="18"/><path d="M16 10h.01"/><path d="M12 10h.01"/><path d="M8 10h.01"/><path d="M12 14h.01"/><path d="M8 14h.01"/><path d="M12 18h.01"/><path d="M8 18h.01"/></svg>
                            Tax & Trade
                        </h3>
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                            <div class="sm:col-span-1">
                                <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">Tax Rate (%)</label>
                                <div class="relative">
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-slate-400">%</div>
                                    <input type="number" id="inp-taxRate" inputmode="decimal" class="block w-full pl-7 pr-3 py-3 border border-slate-200 bg-white rounded-lg focus:ring-2 focus:ring-blue-200 focus:border-blue-500 outline-none transition-all font-mono text-lg text-slate-800 shadow-sm" placeholder="6.625">
                                </div>
                            </div>
                            <div class="sm:col-span-2">
                                <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">Trade-In Value</label>
                                <div class="relative">
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-red-400">-</div>
                                    <input type="number" id="inp-tradeInValue" inputmode="decimal" class="block w-full pl-7 pr-3 py-3 border border-red-100 bg-red-50/30 rounded-lg focus:ring-2 focus:ring-blue-200 focus:border-blue-500 outline-none transition-all font-mono text-lg text-red-600 shadow-sm" placeholder="0">
                                </div>
                            </div>
                        </div>
                        <div class="mt-2 text-xs text-slate-400 px-1">* Calculates tax on (Price - TradeIn).</div>
                    </section>

                    <!-- Payment Breakdown Card -->
                    <div class="mt-8 bg-slate-100 rounded-xl p-5 border border-slate-200 shadow-inner">
                        <h4 class="text-sm font-bold text-slate-600 uppercase mb-4 tracking-wide">Payment Breakdown</h4>
                        <div class="space-y-3 text-sm">
                            <div class="flex justify-between">
                                <span class="text-slate-600">Selling Price</span>
                                <span class="font-medium" id="bd-selling">$0</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-600">Taxable Fees (Doc + Add-ons)</span>
                                <span class="font-medium" id="bd-fees">$0</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-600">Trade-In Credit</span>
                                <span class="text-green-600 font-medium" id="bd-trade">-$0</span>
                            </div>
                            
                            <div class="border-t border-slate-300 my-2"></div>
                            
                            <div class="flex justify-between items-center">
                                <span class="text-slate-500 text-xs uppercase font-semibold">Taxable Amount</span>
                                <span class="text-slate-500" id="bd-taxable">$0</span>
                            </div>
                            
                            <div class="flex justify-between items-center text-blue-800 bg-blue-50 p-2 rounded -mx-2">
                                <span class="font-semibold" id="bd-tax-label">+ NJ Sales Tax (6.625%)</span>
                                <span class="font-bold" id="bd-tax-val">$0</span>
                            </div>
                             <div class="flex justify-between items-center text-blue-800 p-2 pt-0 rounded -mx-2">
                                <span class="font-semibold">+ DMV / Gov Fees</span>
                                <span class="font-bold" id="bd-gov">$0</span>
                            </div>
                            
                            <div class="border-t-2 border-slate-800 my-2"></div>
                            
                            <div class="flex justify-between text-xl font-extrabold text-slate-900">
                                <span>Out-The-Door Total</span>
                                <span id="bd-otd">$0</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Backup / Restore Section -->
            <div class="mt-8 text-center pb-8">
                <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Data Management</h3>
                <div class="flex justify-center gap-3">
                     <button onclick="downloadData()" class="flex items-center gap-1 px-3 py-2 text-xs font-medium text-slate-600 bg-white border border-slate-300 rounded-md hover:bg-slate-50">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                        Backup (Save to File)
                    </button>
                     <label class="flex items-center gap-1 px-3 py-2 text-xs font-medium text-slate-600 bg-white border border-slate-300 rounded-md hover:bg-slate-50 cursor-pointer">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                        Restore (Load File)
                        <input type="file" id="file-upload" class="hidden" accept=".json" onchange="uploadData(this)">
                    </label>
                </div>
                <p class="text-[10px] text-slate-400 mt-2">Data is auto-saved to browser storage.</p>
            </div>
        </div>

        <!-- VIEW: COMPARISON TABLE -->
        <div id="view-comparison" class="hidden fade-in">
            <h2 class="text-xl font-bold text-slate-800 mb-4 flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-600"><polyline points="1 4 1 10 7 10"/><polyline points="23 20 23 14 17 14"/><path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10"/><path d="M3.51 15a9 9 0 0 0 14.85 3.36L23 14"/></svg>
                Comparison Matrix
            </h2>
            <div class="overflow-x-auto rounded-xl border border-slate-200 shadow-sm">
                <table class="w-full text-sm text-left" id="comparison-table">
                    <!-- Table injected by JS -->
                </table>
            </div>
        </div>

    </main>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-4 left-1/2 transform -translate-x-1/2 bg-slate-800 text-white text-xs px-4 py-2 rounded-full shadow-lg opacity-0 transition-opacity duration-300 pointer-events-none z-50">
        Auto-saved
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        // --- Constants & State ---
        const DEFAULT_TAX_RATE = 6.625;
        const STORAGE_KEY = 'carDeals_vanilla';
        
        let state = {
            deals: [],
            activeTab: 0,
            showComparison: false
        };

        // --- Icons ---
        const icons = {
            trash: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>`,
            plus: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>`
        };

        // --- Initialization ---
        function init() {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
                try {
                    state.deals = JSON.parse(saved);
                } catch(e) { console.error("Load error", e); }
            }
            
            if (!state.deals || state.deals.length === 0) {
                addDeal(false); // Add initial deal without render
            }

            // Attach Static Event Listeners
            document.getElementById('btn-toggle-view').addEventListener('click', toggleView);
            document.getElementById('btn-add-fee').addEventListener('click', addCustomFee);
            
            // Attach Input Listeners for Active Deal Form
            const inputs = ['deal-name', 'inp-msrp', 'inp-discount', 'inp-rebates', 'inp-docFee', 'inp-govFees', 'inp-taxRate', 'inp-tradeInValue'];
            inputs.forEach(id => {
                document.getElementById(id).addEventListener('input', handleInput);
            });

            render();
        }

        // --- Actions ---
        function addDeal(doRender = true) {
            state.deals.push({
                id: Date.now(),
                name: `Deal #${state.deals.length + 1}`,
                msrp: 0, discount: 0, rebates: 0,
                tradeInValue: 0, docFee: 0,
                taxRate: DEFAULT_TAX_RATE, govFees: 400,
                customFees: []
            });
            state.activeTab = state.deals.length - 1;
            state.showComparison = false;
            save();
            if(doRender) render();
        }

        function removeDeal(index, e) {
            e.stopPropagation();
            if(confirm("Delete this deal?")) {
                state.deals.splice(index, 1);
                if(state.deals.length === 0) {
                    addDeal(false); // Ensure at least one exists
                    state.activeTab = 0;
                } else if (state.activeTab >= state.deals.length) {
                    state.activeTab = state.deals.length - 1;
                }
                save();
                render();
            }
        }

        function toggleView() {
            state.showComparison = !state.showComparison;
            render();
        }

        function handleInput(e) {
            if (state.showComparison) return;
            const deal = state.deals[state.activeTab];
            const val = e.target.value;
            const id = e.target.id;

            if(id === 'deal-name') deal.name = val;
            else if(id === 'inp-msrp') deal.msrp = val;
            else if(id === 'inp-discount') deal.discount = val;
            else if(id === 'inp-rebates') deal.rebates = val;
            else if(id === 'inp-docFee') deal.docFee = val;
            else if(id === 'inp-govFees') deal.govFees = val;
            else if(id === 'inp-taxRate') deal.taxRate = val;
            else if(id === 'inp-tradeInValue') deal.tradeInValue = val;

            save();
            updateBreakdown(); // Efficient update
            updateTabsNames(); // Update tab name if deal name changed
        }

        function addCustomFee() {
            const deal = state.deals[state.activeTab];
            deal.customFees.push({ id: Date.now(), name: 'Add-on (e.g. Nitrogen)', amount: 0 });
            save();
            renderCustomFees();
            updateBreakdown();
        }

        function updateCustomFee(index, field, val) {
            const deal = state.deals[state.activeTab];
            deal.customFees[index][field] = val;
            save();
            updateBreakdown();
        }

        function removeCustomFee(index) {
            const deal = state.deals[state.activeTab];
            deal.customFees.splice(index, 1);
            save();
            renderCustomFees();
            updateBreakdown();
        }

        function switchTab(index) {
            state.activeTab = index;
            state.showComparison = false;
            render();
        }
        
        // --- Backup / Restore ---
        function downloadData() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(state.deals));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "my_car_deals.json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        function uploadData(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const json = JSON.parse(e.target.result);
                    if (Array.isArray(json)) {
                        state.deals = json;
                        state.activeTab = 0;
                        state.showComparison = false;
                        save();
                        render();
                        showToast("Deals loaded successfully!");
                    } else {
                        alert("Invalid file format.");
                    }
                } catch (err) {
                    alert("Error reading file.");
                }
            };
            reader.readAsText(file);
            input.value = ''; // Reset input
        }

        // --- Calculations ---
        function calculate(deal) {
            const msrp = parseFloat(deal.msrp) || 0;
            const discount = parseFloat(deal.discount) || 0;
            const rebates = parseFloat(deal.rebates) || 0;
            const tradeIn = parseFloat(deal.tradeInValue) || 0;
            const docFee = parseFloat(deal.docFee) || 0;
            const govFees = parseFloat(deal.govFees) || 0;
            const taxRate = parseFloat(deal.taxRate) || 0;

            const customTotal = deal.customFees.reduce((sum, f) => sum + (parseFloat(f.amount) || 0), 0);
            
            const sellingPrice = msrp - discount - rebates;
            let taxableAmount = sellingPrice + docFee + customTotal - tradeIn;
            if(taxableAmount < 0) taxableAmount = 0;
            
            const taxAmount = taxableAmount * (taxRate / 100);
            const otdPrice = sellingPrice + docFee + customTotal + taxAmount + govFees;

            return { sellingPrice, taxableAmount, taxAmount, otdPrice, customTotal };
        }

        function formatMoney(num) {
            return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(num);
        }

        // --- Rendering ---
        function render() {
            const btnToggle = document.getElementById('btn-toggle-view');
            const viewForm = document.getElementById('view-form');
            const viewComp = document.getElementById('view-comparison');

            btnToggle.textContent = state.showComparison ? 'Edit Deals' : 'Compare';
            btnToggle.className = `text-sm font-semibold px-4 py-1.5 rounded-full transition-colors ${state.showComparison ? 'bg-white text-blue-900' : 'bg-blue-800 text-blue-100 hover:bg-blue-700'} shadow-sm border border-blue-700`;

            if (state.showComparison) {
                viewForm.classList.add('hidden');
                viewComp.classList.remove('hidden');
                renderComparisonTable();
            } else {
                viewForm.classList.remove('hidden');
                viewComp.classList.add('hidden');
                renderTabs();
                populateForm(); // Set input values
                renderCustomFees();
                updateBreakdown(); // Calculate totals
            }
        }

        function renderTabs() {
            const container = document.getElementById('tabs-container');
            container.innerHTML = '';
            
            state.deals.forEach((deal, idx) => {
                const btn = document.createElement('button');
                const isActive = idx === state.activeTab;
                btn.className = `flex-shrink-0 px-4 py-2 rounded-lg border font-medium transition-all flex items-center gap-2 select-none ${isActive ? 'bg-blue-600 text-white border-blue-600 shadow-md' : 'bg-white text-slate-600 border-slate-200 hover:border-blue-300'}`;
                btn.onclick = () => switchTab(idx);
                
                const span = document.createElement('span');
                span.className = 'whitespace-nowrap max-w-[100px] overflow-hidden text-ellipsis';
                span.textContent = deal.name;
                
                btn.appendChild(span);

                if (state.deals.length > 1) {
                    const delBtn = document.createElement('span');
                    delBtn.className = `ml-2 p-1 rounded hover:bg-white/20 ${isActive ? 'text-blue-100 hover:text-white' : 'text-slate-400 hover:text-red-500'}`;
                    delBtn.innerHTML = icons.trash;
                    delBtn.onclick = (e) => removeDeal(idx, e);
                    btn.appendChild(delBtn);
                }
                container.appendChild(btn);
            });

            const addBtn = document.createElement('button');
            addBtn.className = "flex-shrink-0 w-12 flex items-center justify-center rounded-lg border border-dashed border-slate-400 text-slate-500 hover:bg-slate-100 hover:text-blue-600 hover:border-blue-400 transition-colors";
            addBtn.innerHTML = icons.plus;
            addBtn.onclick = () => addDeal();
            container.appendChild(addBtn);
        }

        function populateForm() {
            const deal = state.deals[state.activeTab];
            if(!deal) return;

            // Helper to safely set value
            const setVal = (id, val) => {
                const el = document.getElementById(id);
                if(el) el.value = (val === 0 || val === '0') ? '' : val;
            };

            setVal('deal-name', deal.name);
            setVal('inp-msrp', deal.msrp);
            setVal('inp-discount', deal.discount);
            setVal('inp-rebates', deal.rebates);
            setVal('inp-docFee', deal.docFee);
            setVal('inp-govFees', deal.govFees);
            setVal('inp-taxRate', deal.taxRate);
            setVal('inp-tradeInValue', deal.tradeInValue);
        }

        function renderCustomFees() {
            const container = document.getElementById('custom-fees-container');
            container.innerHTML = '';
            const deal = state.deals[state.activeTab];
            
            deal.customFees.forEach((fee, idx) => {
                const row = document.createElement('div');
                row.className = "flex gap-2 items-end animate-fadeIn";
                row.innerHTML = `
                    <div class="flex-grow">
                        <label class="block text-xs font-medium text-slate-500 mb-1">Fee Name</label>
                        <input type="text" class="w-full p-2 bg-white border border-slate-200 rounded-md focus:ring-2 focus:ring-orange-200 focus:border-orange-400 outline-none text-sm" value="${fee.name}" oninput="updateCustomFee(${idx}, 'name', this.value)">
                    </div>
                    <div class="w-24 sm:w-28">
                        <label class="block text-xs font-medium text-slate-500 mb-1">Amount</label>
                        <input type="number" class="w-full p-2 bg-white border border-slate-200 rounded-md focus:ring-2 focus:ring-orange-200 focus:border-orange-400 outline-none text-sm" value="${fee.amount}" oninput="updateCustomFee(${idx}, 'amount', this.value)">
                    </div>
                    <button onclick="removeCustomFee(${idx})" class="p-2 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded-md transition-colors mb-[1px]">${icons.trash}</button>
                `;
                container.appendChild(row);
            });
        }

        function updateBreakdown() {
            const deal = state.deals[state.activeTab];
            if(!deal) return;
            const calcs = calculate(deal);

            document.getElementById('header-otd').textContent = formatMoney(calcs.otdPrice);
            document.getElementById('bd-selling').textContent = formatMoney(calcs.sellingPrice);
            
            const feesTotal = (parseFloat(deal.docFee)||0) + calcs.customTotal;
            document.getElementById('bd-fees').textContent = formatMoney(feesTotal);
            document.getElementById('bd-trade').textContent = '-' + formatMoney(deal.tradeInValue||0);
            document.getElementById('bd-taxable').textContent = formatMoney(calcs.taxableAmount);
            
            document.getElementById('bd-tax-label').textContent = `+ NJ Sales Tax (${deal.taxRate}%)`;
            document.getElementById('bd-tax-val').textContent = formatMoney(calcs.taxAmount);
            document.getElementById('bd-gov').textContent = formatMoney(deal.govFees||0);
            document.getElementById('bd-otd').textContent = formatMoney(calcs.otdPrice);
        }
        
        function updateTabsNames() {
             const deal = state.deals[state.activeTab];
             // Straightforward re-render to keep it synced
             renderTabs();
        }

        function renderComparisonTable() {
            const table = document.getElementById('comparison-table');
            const deals = state.deals;
            const calculations = deals.map(calculate);
            const bestPrice = Math.min(...calculations.map(c => c.otdPrice));

            let html = `<thead class="bg-slate-50 text-slate-500 uppercase text-xs font-bold tracking-wider border-b border-slate-200"><tr><th class="p-4 sticky left-0 bg-slate-50 z-10">Details</th>`;
            
            deals.forEach((d, i) => {
                const isBest = calculations[i].otdPrice === bestPrice;
                html += `<th class="p-4 min-w-[140px] ${isBest ? 'bg-green-50 text-green-700 border-b-2 border-green-500' : ''}">
                    ${d.name}
                    ${isBest ? '<span class="block text-[10px] font-normal normal-case bg-green-200 text-green-800 px-1 rounded w-fit mt-1">Best Price</span>' : ''}
                </th>`;
            });
            html += `</tr></thead><tbody class="divide-y divide-slate-100 bg-white">`;

            const row = (label, valueFn, className = "") => {
                html += `<tr><td class="p-3 font-medium text-slate-600 sticky left-0 bg-white">${label}</td>`;
                deals.forEach((d, i) => {
                    html += `<td class="p-3 ${className}">${valueFn(d, calculations[i])}</td>`;
                });
                html += `</tr>`;
            };

            row('MSRP', d => formatMoney(d.msrp));
            row('Total Discount', d => `-${formatMoney((parseFloat(d.discount)||0) + (parseFloat(d.rebates)||0))}`, 'text-green-600 bg-green-50/30');
            row('Selling Price', (d, c) => formatMoney(c.sellingPrice), 'font-semibold');
            row('Doc Fee', d => formatMoney(d.docFee));
            row('Other Fees', (d, c) => formatMoney(c.customTotal), 'text-orange-600');
            row('Taxes', (d, c) => `${formatMoney(c.taxAmount)}`, 'text-xs sm:text-sm');
            row('Gov Fees', d => formatMoney(d.govFees));
            
            // OTD Row
            html += `<tr class="bg-slate-50 border-t-2 border-slate-200"><td class="p-4 font-bold text-slate-900 sticky left-0 bg-slate-50">OTD TOTAL</td>`;
            deals.forEach((d, i) => {
                 const isBest = calculations[i].otdPrice === bestPrice;
                 html += `<td class="p-4 font-extrabold text-lg ${isBest ? 'text-green-600' : 'text-slate-900'}">${formatMoney(calculations[i].otdPrice)}</td>`;
            });
            html += `</tr></tbody>`;

            table.innerHTML = html;
        }

        function save() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(state.deals));
            // Debounce toast? Nah, just show briefly
            // showToast('Saved'); 
        }

        let toastTimeout;
        function showToast(msg) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.classList.remove('opacity-0');
            clearTimeout(toastTimeout);
            toastTimeout = setTimeout(() => t.classList.add('opacity-0'), 2000);
        }

        // Run
        init();

    </script>
</body>
</html>